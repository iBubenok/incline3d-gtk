name: Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ==========================================================================
  # Linux Build (Ubuntu)
  # ==========================================================================
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [gcc, clang]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libgtk-4-dev \
          libepoxy-dev \
          ${{ matrix.compiler == 'clang' && 'clang' || '' }}

    - name: Configure CMake
      env:
        CC: ${{ matrix.compiler == 'clang' && 'clang' || 'gcc' }}
        CXX: ${{ matrix.compiler == 'clang' && 'clang++' || 'g++' }}
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTING=ON \
          -DBUILD_GUI=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --parallel 4

  # ==========================================================================
  # Linux Core-Only Build (без GTK4)
  # ==========================================================================
  linux-core-only:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build

    - name: Configure CMake (core only)
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -DBUILD_GUI=OFF

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --parallel 4

  # ==========================================================================
  # Windows Build (MSYS2)
  # ==========================================================================
  windows-msys2:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: actions/checkout@v4

    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-libepoxy

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -DBUILD_GUI=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --parallel 4

  # ==========================================================================
  # Windows Core-Only Build (MSVC)
  # ==========================================================================
  windows-msvc:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake (core only, MSVC)
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_TESTING=ON `
          -DBUILD_GUI=OFF

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Run tests
      run: ctest --test-dir build --output-on-failure -C Release --parallel 4

  # ==========================================================================
  # macOS Build
  # ==========================================================================
  macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja gtk4

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -DBUILD_GUI=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --parallel 4
