# Матрица совместимости с PrimeINCL (Delphi)

## Обзор

Документ отслеживает соответствие реализации incline3d-gtk эталонной Delphi-версии PrimeINCL.

**Условные обозначения:**
- DONE — полностью соответствует Delphi
- PARTIAL — частичное соответствие, требует доработки
- TODO — не реализовано
- DIFFERS — реализовано, но отличается от Delphi
- N/A — не применимо

---

## 1. Алгоритмы расчёта траектории

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Average Angle (Метод 0) | DONE | test_trajectory.cpp | Полностью совпадает с unitcalc.pas:858-882 |
| Balanced Tangential (Метод 1) | DONE | test_trajectory.cpp | Полностью совпадает с unitcalc.pas:989-1000 |
| Minimum Curvature (Метод 2) | **DIFFERS** | TODO | См. раздел "Критические расхождения" |
| Ring Arc (Метод 3) | DONE | test_trajectory.cpp | Полностью совпадает с unitcalc.pas:1302-1338 |

### Критическое расхождение: Minimum Curvature

**Delphi реализация** (unitcalc.pas:1156-1196) использует **интегральный метод**:

```
При u ≠ u1 и a ≠ a1:
  ΔX = L × (cos(u1) - cos(u)) × (sin(a) - sin(a1)) / (2 × (u - u1) × sin(delta/2))
  ΔY = L × (cos(u1) - cos(u)) × (cos(a1) - cos(a)) / (2 × (u - u1) × sin(delta/2))
  ΔZ = L × (sin(u) - sin(u1)) / (u - u1)

Особые случаи:
  - u = u1, a = a1: прямолинейный участок
  - u ≠ u1, a = a1: изменение только зенита
  - u = u1, a ≠ a1: изменение только азимута
```

**Текущая C++ реализация** использует **классический Minimum Curvature с RF**:

```
RF = (2/DL) × tan(DL/2)
ΔX = (L/2) × RF × (sin(θ1)cos(φ1) + sin(θ2)cos(φ2))
```

**Действие:** Требуется реализация Delphi-совместимого метода как отдельной опции или замена текущего.

---

## 2. Расчёт dogleg (интенсивность искривления)

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| CalcDLCos (через косинус) | DONE | test_angle_utils.cpp | Соответствует UnitCalcProcs.pas:56-60 |
| CalcDLSin (через синус) | **TODO** | - | Метод по умолчанию в Delphi, не реализован |
| Интенсивность на 10м | DONE | - | Формула: 10 × DL_deg / L |
| Интенсивность на L м | DONE | - | Формула: L_int × DL_deg / L |
| Зенитная интенсивность | TODO | - | Только по зенитному углу, без азимута |

### Формула CalcDLSin (не реализована)

```cpp
// DL = 2 × arcsin(√[sin²((θ2-θ1)/2) + sin²((θ2+θ1)/2) × sin²((φ2-φ1)/2)])
double calcDLSin(double a2, double a1, double zen2, double zen1) {
    double result = std::sqrt(
        std::pow(std::sin((zen2 - zen1) / 2.0), 2) +
        std::pow(std::sin((zen2 + zen1) / 2.0) * std::sin((a2 - a1) / 2.0), 2)
    );
    return 2.0 * std::asin(result);
}
```

---

## 3. Обработка вертикальных участков

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Критический угол U_кр | DONE | - | Параметр critical_inclination в ProcessingSettings |
| Blanking X, Y при угле < U_кр | **PARTIAL** | TODO | Требует тестов на реальных данных |
| Blanking азимута (DoBlankAzimInVertInterval) | TODO | - | Флаг в Delphi GlobalOptions |
| Приустьевая зона | DONE | - | Параметр conductor_shoe в ProcessingSettings |

---

## 4. Обработка азимутов

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Нормализация 0-360 | DONE | test_angle_utils.cpp | |
| Усреднение через короткую дугу | DONE | test_angle_utils.cpp | |
| Обработка перехода 0/360 | DONE | test_angle_utils.cpp | Порог 180° |
| Интерполяция пропусков | TODO | - | Требуется реализация |
| Продление последнего азимута | TODO | - | Параметр extend_last_azimuth |
| Вертикальная при отсутствии азимутов | **PARTIAL** | - | Флаг vertical_if_no_azimuth |

---

## 5. Расчёт погрешностей

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Погрешность X | DONE | - | Через ErrorAccumulator |
| Погрешность Y | DONE | - | |
| Погрешность ABSG (Z) | DONE | - | |
| Погрешность интенсивности | **PARTIAL** | - | Упрощённая формула |
| Коэффициент 95% (1.96) | DONE | - | Константа kConfidence95 |
| Делитель дисперсии (/2) | DONE | - | Эмпирический из Delphi |

---

## 6. Ввод-вывод

| Формат | Статус | Тесты | Примечания |
|--------|--------|-------|------------|
| CSV чтение | DONE | - | С автоопределением кодировки |
| CSV запись | DONE | - | CP1251/UTF-8 |
| LAS 2.0 чтение | DONE | - | |
| LAS 2.0 запись | DONE | - | |
| ZAK чтение | **TODO** | - | Приоритет: высокий |
| ZAK запись | **TODO** | - | |
| Проект *.inclproj | DONE | - | JSON формат |
| WS-совместимый формат | TODO | - | Требуется анализ |

---

## 7. Интерфейс пользователя

| Функция | Статус | Тесты | Примечания |
|--------|--------|-------|------------|
| Главное окно | PARTIAL | - | Заглушка |
| Таблица замеров | TODO | - | |
| Таблица результатов | TODO | - | |
| 3D аксонометрия | TODO | - | GtkGLArea готов |
| План (2D) | TODO | - | Cairo готов |
| Вертикальная проекция | TODO | - | Cairo готов |
| Диалог настроек обработки | TODO | - | |
| Диалог импорта | TODO | - | |
| Диалог экспорта | TODO | - | |

---

## 8. Анализ и отчёты

| Функция | Статус | Тесты | Примечания |
|--------|--------|-------|------------|
| Анализ сближения | **PARTIAL** | - | Функция analyzeConvergence() |
| Анализ отхода | TODO | - | |
| Многоскважинная обработка | TODO | - | |
| Генерация заключения | TODO | - | |
| Экспорт изображений | TODO | - | |

---

## 9. Константы и пороги

| Параметр | Delphi | C++ | Статус |
|----------|--------|-----|--------|
| BlankSingle | -999.25 | std::nullopt | DONE (разная семантика) |
| Порог нормализации 360→0 | - | 1e-4 | DONE |
| Порог малого dogleg | - | 1e-7 rad | DONE |
| Порог нулевого интервала | - | 1e-9 м | DONE |
| Коэффициент 95% | 1.96 | 1.96 | DONE |
| IntensLength | 10 м | 10 м | DONE |
| Окно сглаживания | ±5 м | - | TODO |

---

## Приоритеты исправлений

### P0 — Критические (влияют на результаты расчётов)

1. **Minimum Curvature** — реализовать Delphi-совместимый интегральный метод
2. **CalcDLSin** — добавить метод dogleg через синус как опцию

### P1 — Высокие (функциональность)

3. **ZAK формат** — импорт/экспорт
4. **Интерполяция азимутов** — для пропусков в данных
5. **Blanking азимута в вертикальных участках**

### P2 — Средние (UI)

6. Полная реализация диалогов
7. Визуализация (3D, план, вертикальная проекция)
8. Таблицы данных

### P3 — Низкие (дополнительно)

9. Многоскважинная обработка
10. Генерация заключений
11. Экспорт изображений

---

## История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-16 | 0.3.0 | Создан документ, выявлены критические расхождения |
