# Матрица совместимости с PrimeINCL (Delphi)

## Обзор

Документ отслеживает соответствие реализации incline3d-gtk эталонной Delphi-версии PrimeINCL.

**Условные обозначения:**
- DONE — полностью соответствует Delphi
- PARTIAL — частичное соответствие, требует доработки
- TODO — не реализовано
- DIFFERS — реализовано, но отличается от Delphi
- N/A — не применимо

---

## 1. Алгоритмы расчёта траектории

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Average Angle (Метод 0) | DONE | test_trajectory.cpp | Полностью совпадает с unitcalc.pas:858-882 |
| Balanced Tangential (Метод 1) | DONE | test_trajectory.cpp | Полностью совпадает с unitcalc.pas:989-1000 |
| Minimum Curvature (классический) | DONE | test_trajectory.cpp | Стандартный SPE метод с RF |
| **Minimum Curvature (Delphi)** | **DONE** | test_trajectory.cpp | `MinimumCurvatureIntegral` — интегральный метод |
| Ring Arc (Метод 3) | DONE | test_trajectory.cpp | Полностью совпадает с unitcalc.pas:1302-1338 |

### Minimum Curvature: два варианта

**1. Классический MC (`MinimumCurvature`)**

Стандартный SPE метод через Ratio Factor:
```
RF = (2/DL) × tan(DL/2)
ΔX = (L/2) × RF × (sin(θ1)cos(φ1) + sin(θ2)cos(φ2))
```

**2. Delphi MC (`MinimumCurvatureIntegral`)** ✅ РЕАЛИЗОВАН

Интегральный метод из unitcalc.pas:1156-1196:
```
При u ≠ u1 и a ≠ a1:
  ΔX = L × (cos(u1) - cos(u)) × (sin(a) - sin(a1)) / (u - u1) / (a - a1)
  ΔY = L × (cos(u1) - cos(u)) × (cos(a1) - cos(a)) / (u - u1) / (a - a1)
  ΔZ = L × (sin(u) - sin(u1)) / (u - u1)

Особые случаи:
  - u = u1, a = a1: прямолинейный участок
  - u ≠ u1, a = a1: изменение только зенита
  - u = u1, a ≠ a1: изменение только азимута
```

Для Delphi-совместимости используйте `TrajectoryMethod::MinimumCurvatureIntegral`.

---

## 2. Расчёт dogleg (интенсивность искривления)

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| CalcDLCos (через косинус) | DONE | test_parity_trajectory.cpp | Соответствует UnitCalcProcs.pas:56-60 |
| **CalcDLSin (через синус)** | **DONE** | test_parity_trajectory.cpp | Метод по умолчанию в Delphi |
| Интенсивность на 10м | DONE | test_parity_trajectory.cpp | Формула: 10 × DL_deg / L |
| Интенсивность на L м | DONE | - | Формула: L_int × DL_deg / L |
| Зенитная интенсивность | TODO | - | Только по зенитному углу, без азимута |
| **DoglegMethod enum** | **DONE** | - | Выбор между Cosine и Sine |

### Выбор метода dogleg

Добавлен `DoglegMethod` enum в `ProcessingSettings`:

```cpp
enum class DoglegMethod {
    Cosine,   // Стандартный SPE метод (по умолчанию в большинстве софта)
    Sine      // Метод Delphi (по умолчанию для совместимости)
};

ProcessingSettings settings;
settings.dogleg_method = DoglegMethod::Sine;  // Delphi-совместимость
```

**Формула CalcDLSin:**
```
DL = 2 × arcsin(√[sin²((θ2-θ1)/2) + sin²((θ2+θ1)/2) × sin²((φ2-φ1)/2)])
```

---

## 3. Обработка вертикальных участков

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Критический угол U_кр | DONE | - | Параметр critical_inclination в ProcessingSettings |
| Blanking X, Y при угле < U_кр | **PARTIAL** | TODO | Требует тестов на реальных данных |
| Blanking азимута (DoBlankAzimInVertInterval) | TODO | - | Флаг в Delphi GlobalOptions |
| Приустьевая зона | DONE | - | Параметр conductor_shoe в ProcessingSettings |

---

## 4. Обработка азимутов

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Нормализация 0-360 | DONE | test_angle_utils.cpp | |
| Усреднение через короткую дугу | DONE | test_angle_utils.cpp | |
| Обработка перехода 0/360 | DONE | test_angle_utils.cpp | Порог 180° |
| Интерполяция пропусков | TODO | - | Требуется реализация |
| Продление последнего азимута | TODO | - | Параметр extend_last_azimuth |
| Вертикальная при отсутствии азимутов | **PARTIAL** | - | Флаг vertical_if_no_azimuth |

---

## 5. Расчёт погрешностей

| Функция | Статус | Тесты | Примечания |
|---------|--------|-------|------------|
| Погрешность X | DONE | - | Через ErrorAccumulator |
| Погрешность Y | DONE | - | |
| Погрешность ABSG (Z) | DONE | - | |
| Погрешность интенсивности | **PARTIAL** | - | Упрощённая формула |
| Коэффициент 95% (1.96) | DONE | - | Константа kConfidence95 |
| Делитель дисперсии (/2) | DONE | - | Эмпирический из Delphi |

---

## 6. Ввод-вывод

| Формат | Статус | Тесты | Примечания |
|--------|--------|-------|------------|
| CSV чтение | DONE | - | С автоопределением кодировки |
| CSV запись | DONE | - | CP1251/UTF-8 |
| LAS 2.0 чтение | DONE | - | |
| LAS 2.0 запись | DONE | - | |
| **ZAK чтение** | **DONE** | - | Автоопределение CP1251/UTF-8, гибкий парсинг |
| ZAK запись | TODO | - | |
| Проект *.inclproj | DONE | - | JSON формат |
| WS-совместимый формат | TODO | - | Требуется анализ |

### Формат ZAK

Секционный текстовый формат для заключений:
```
#HEADER
WELL=123-1
CLUSTER=Куст 5
FIELD=Месторождение
DATE=2025-12-16
ALTITUDE=150.0
DECLINATION=8.5
#MEASUREMENTS
MD;INC;AZ
0.0;0.0;
100.0;2.5;45.0
#END
```

Поддерживаемые секции:
- `#HEADER` — метаданные скважины
- `#MEASUREMENTS` — данные замеров
- `#END` — конец файла

Поддержка разделителей: `;`, `,`, `\t`

---

## 7. Интерфейс пользователя

| Функция | Статус | Тесты | Примечания |
|--------|--------|-------|------------|
| Главное окно | PARTIAL | - | Заглушка |
| Таблица замеров | TODO | - | |
| Таблица результатов | TODO | - | |
| 3D аксонометрия | TODO | - | GtkGLArea готов |
| План (2D) | TODO | - | Cairo готов |
| Вертикальная проекция | TODO | - | Cairo готов |
| Диалог настроек обработки | TODO | - | |
| Диалог импорта | TODO | - | |
| Диалог экспорта | TODO | - | |

---

## 8. Анализ и отчёты

| Функция | Статус | Тесты | Примечания |
|--------|--------|-------|------------|
| Анализ сближения | **PARTIAL** | - | Функция analyzeConvergence() |
| Анализ отхода | TODO | - | |
| Многоскважинная обработка | TODO | - | |
| Генерация заключения | TODO | - | |
| Экспорт изображений | TODO | - | |

---

## 9. Константы и пороги

| Параметр | Delphi | C++ | Статус |
|----------|--------|-----|--------|
| BlankSingle | -999.25 | std::nullopt | DONE (разная семантика) |
| Порог нормализации 360→0 | - | 1e-4 | DONE |
| Порог малого dogleg | - | 1e-7 rad | DONE |
| Порог нулевого интервала | - | 1e-9 м | DONE |
| Коэффициент 95% | 1.96 | 1.96 | DONE |
| IntensLength | 10 м | 10 м | DONE |
| Окно сглаживания | ±5 м | - | TODO |

---

## Приоритеты исправлений

### P0 — Критические (влияют на результаты расчётов)

1. ~~**Minimum Curvature**~~ — ✅ реализован `MinimumCurvatureIntegral`
2. ~~**CalcDLSin**~~ — ✅ реализован с `DoglegMethod` enum

### P1 — Высокие (функциональность)

3. ~~**ZAK формат (чтение)**~~ — ✅ реализован
4. **ZAK формат (запись)** — TODO
5. **Интерполяция азимутов** — для пропусков в данных
6. **Blanking азимута в вертикальных участках**

### P2 — Средние (UI)

7. Полная реализация диалогов
8. Визуализация (3D, план, вертикальная проекция)
9. Таблицы данных

### P3 — Низкие (дополнительно)

10. Многоскважинная обработка
11. Генерация заключений
12. Экспорт изображений

---

## История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-16 | 0.5.0 | Реализован Delphi MC, CalcDLSin, DoglegMethod, ZAK чтение |
| 2025-12-16 | 0.4.0 | Исправлены ошибки сборки CI, все предупреждения компилятора |
| 2025-12-16 | 0.3.0 | Создан документ, выявлены критические расхождения |
